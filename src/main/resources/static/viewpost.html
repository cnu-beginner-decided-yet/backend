<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>게시글 상세보기</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="styles.css">
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="app">
<div class="container">
<header class="app-header">
    <h1 class="app-title">게시글 상세</h1>
    <div class="controls">
        <button id="btnBack" class="btn secondary small">목록으로</button>
        <button id="btnMypage" class="btn ghost small">마이페이지</button>
        <button id="btnLogout" class="btn ghost small">로그아웃</button>
    </div>
</header>
<section class="card" id="postDetail">
    <div id="postDetailContent" style="display:flex;align-items:center;justify-content:center;min-height:120px;">
        <div id="loadingSpinner" style="display:block;margin:auto;text-align:center;">
            <svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg" style="animation:spin 1s linear infinite;">
                <circle cx="24" cy="24" r="20" stroke="#03c75a" stroke-width="6" stroke-linecap="round" stroke-dasharray="100 40"/>
            </svg>
            <div style="margin-top:12px;color:#03c75a;font-weight:600;font-size:1.08rem;">불러오는 중...</div>
        </div>
    </div>
    <div id="postDetailMsg" class="msg"></div>
    <div id="postDetailErr" class="err"></div>
</section>
<script>
const BASE_URL = 'http://localhost:8080';
const getToken = () => localStorage.getItem('jwt_token');
function getAuthHeaders() {
    const token = getToken();
    return token ? { 'Authorization': 'Bearer ' + token } : {};
}
const postDetailContent = document.getElementById('postDetailContent');
const postDetailMsg = document.getElementById('postDetailMsg');
const postDetailErr = document.getElementById('postDetailErr');
const btnBack = document.getElementById('btnBack');
const btnMypage = document.getElementById('btnMypage');
const btnLogout = document.getElementById('btnLogout');

function getPostIdFromUrl() {
    const params = new URLSearchParams(window.location.search);
    return params.get('id');
}

async function loadPostDetail() {
    postDetailMsg.textContent = '';
    postDetailErr.textContent = '';
    document.getElementById('loadingSpinner').style.display = 'block';
    postDetailContent.innerHTML = document.getElementById('loadingSpinner').outerHTML;
    const postId = getPostIdFromUrl();
    if (!postId) {
        postDetailErr.textContent = '잘못된 접근입니다.';
        postDetailContent.innerHTML = '';
        return;
    }
    try {
        const res = await fetch(BASE_URL + '/api/posts/' + postId, {
            method: 'GET',
            headers: { ...getAuthHeaders() }
        });
        if (!res.ok) {
            postDetailErr.textContent = '게시글을 불러올 수 없습니다.';
            postDetailContent.textContent = '';
            return;
        }
        const post = await res.json();
        renderPostDetail(post);
    } catch (e) {
        postDetailErr.textContent = '네트워크 오류';
        postDetailContent.textContent = '';
    }
}

function renderPostDetail(post) {
    document.getElementById('loadingSpinner').style.display = 'none';
    postDetailContent.style.display = 'block';
    postDetailContent.innerHTML = `
        <div class="title" style="font-size:1.5rem;font-weight:700;color:var(--naver-green);margin-bottom:10px;">${post.title}</div>
        <div class="meta" style="color:#888;margin-bottom:12px;">카테고리: ${post.categoryName ?? ''} | 작성자: ${post.authorName ?? post.author ?? ''} | 작성일: ${post.createdAt ?? ''}</div>
        <div class="excerpt" style="margin-bottom:18px;">${post.content ? post.content.replace(/\n/g,'<br>') : ''}</div>
        <div class="chips">${post.tags && post.tags.length ? post.tags.map(tag => `<span class='chip'>#${tag}</span>`).join(' ') : ''}</div>
    `;
}

btnBack.addEventListener('click', () => window.location.href = 'postlist.html');
btnMypage.addEventListener('click', () => window.location.href = 'mypage.html');
btnLogout.addEventListener('click', () => {
    localStorage.removeItem('jwt_token');
    window.location.href = 'login.html';
});

loadPostDetail();
</script>
</div>
</body>
</html>
