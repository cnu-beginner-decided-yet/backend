<!doctype html>
<html lang="ko">
<head>
    <link rel="stylesheet" href="styles.css">
    <meta charset="utf-8" />
    <title>마이페이지 - 내 글 목록</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
</head>
<body class="app">
<div class="container">
<header class="app-header">
    <h1 class="app-title">마이페이지</h1>
    <div class="controls">
        <button id="btnBack" class="btn secondary small">메인으로</button>
        <button id="btnLogout" class="btn ghost small">로그아웃</button>
    </div>
</header>

<section class="card">
    <h3>내가 작성한 글</h3>
    <div id="myPostList" class="grid"></div>
    <div id="myPostMsg" class="msg"></div>
    <div id="myPostErr" class="err"></div>
</section>

<script>
const BASE_URL = 'http://localhost:8080';
const getToken = () => localStorage.getItem('jwt_token');
function getAuthHeaders() {
    const token = getToken();
    return token ? { 'Authorization': 'Bearer ' + token } : {};
}

const myPostList = document.getElementById('myPostList');
const myPostMsg = document.getElementById('myPostMsg');
const myPostErr = document.getElementById('myPostErr');
const btnBack = document.getElementById('btnBack');
const btnLogout = document.getElementById('btnLogout');

async function loadMyPosts() {
    myPostMsg.textContent = '';
    myPostErr.textContent = '';
    myPostList.innerHTML = '';
    const token = getToken();
    if (!token) {
        myPostErr.textContent = '로그인이 필요합니다.';
        return;
    }
    try {
        const res = await fetch(BASE_URL + '/api/posts/my', {
            method: 'GET',
            headers: { ...getAuthHeaders() }
        });
        if (!res.ok) {
            myPostErr.textContent = '내 글을 불러올 수 없습니다.';
            return;
        }
        const posts = await res.json();
        if (!posts || posts.length === 0) {
            myPostMsg.textContent = '작성한 글이 없습니다.';
            return;
        }
        renderMyPosts(posts);
    } catch (e) {
        myPostErr.textContent = '네트워크 오류';
    }
}

function renderMyPosts(posts) {
    myPostList.innerHTML = '';
    posts.forEach(post => {
        const card = document.createElement('div');
        card.className = 'post';
        card.innerHTML = `
            <div class="title">${post.title}</div>
            <div class="meta">${post.categoryName ? post.categoryName : ''} | ${post.createdAt ? post.createdAt : ''}</div>
            <div class="excerpt">${post.excerpt ? post.excerpt : (post.content ? post.content.substring(0, 80) + '...' : '')}</div>
            <div class="post-actions">
                <button class="btn small" onclick="location.href='viewpost.html?id=${post.id}'">상세보기</button>
            </div>
        `;
        myPostList.appendChild(card);
    });
}

btnBack.addEventListener('click', () => window.location.href = 'postlist.html');
btnLogout.addEventListener('click', () => {
    localStorage.removeItem('jwt_token');
    window.location.href = 'login.html';
});

loadMyPosts();
</script>
</div>
</body>
</html>

