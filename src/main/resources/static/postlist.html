<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>게시글 목록</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="styles.css">
</head>
<body class="app">
<div class="container">
<header class="app-header">
    <h1 class="app-title">게시글 목록</h1>
    <div class="controls">
        <button id="btnRefresh" class="btn small">새로고침</button>
        <button id="btnCreateToggle" class="btn primary small">새 글 작성</button>
        <button id="btnMypage" class="btn ghost small">마이페이지</button>
        <button id="btnLogout" class="btn ghost small">로그아웃</button>
    </div>
</header>
<div id="categoryBtnBar" style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:18px;"></div>

<section id="createSection" class="card" style="display:none;margin-top:12px">
    <h3>새 글 작성</h3>
    <form id="createForm" class="form-row">
        <input id="title" placeholder="제목" required />
        <textarea id="content" placeholder="내용" rows="6" required></textarea>
        <input id="tags" placeholder="태그 (쉼표로 구분)" />
        <input id="categoryId" type="number" placeholder="카테고리 ID (선택)" />
        <button type="submit" class="btn primary">작성</button>
        <div id="createMsg" class="msg"></div>
        <div id="createErr" class="err"></div>
    </form>
</section>

<section class="card mt-8">
    <div class="controls">
        <div style="flex:1;max-width:220px;">
            <input id="searchTitle" class="search-input" placeholder="제목으로 검색" />
        </div>
        <button id="btnSearchTitle" class="btn mini primary" title="제목 검색">검색</button>

        <div style="flex:1;max-width:220px;">
            <input id="searchContent" class="search-input" placeholder="내용으로 검색" />
        </div>
        <button id="btnSearchContent" class="btn mini primary" title="내용 검색">검색</button>

        <div style="flex:1;max-width:180px;">
            <input id="searchTag" class="search-input" placeholder="태그로 검색" />
        </div>
        <button id="btnSearchTag" class="btn mini primary" title="태그 검색">검색</button>
    </div>
</section>

<main id="postList"></main>

<script>
    const BASE_URL = 'http://localhost:8080';
    const postListEl = document.getElementById('postList');
    const btnRefresh = document.getElementById('btnRefresh');
    const btnCreateToggle = document.getElementById('btnCreateToggle');
    const createSection = document.getElementById('createSection');
    const createForm = document.getElementById('createForm');
    const btnLogout = document.getElementById('btnLogout');
    const btnMypage = document.getElementById('btnMypage');

    const getToken = () => localStorage.getItem('jwt_token');

    function getAuthHeaders() {
        const token = getToken();
        return token ? { 'Authorization': 'Bearer ' + token } : {};
    }

    async function loadPosts(url = BASE_URL + '/api/posts') {
        postListEl.innerHTML = `<div style="display:flex;align-items:center;justify-content:center;min-height:120px;">
            <div style="margin:auto;text-align:center;">
                <svg width='40' height='40' viewBox='0 0 48 48' fill='none' xmlns='http://www.w3.org/2000/svg' style='animation:spin 1s linear infinite;'>
                    <circle cx='24' cy='24' r='20' stroke='#03c75a' stroke-width='6' stroke-linecap='round' stroke-dasharray='100 40'/>
                </svg>
                <div style='margin-top:10px;color:#03c75a;font-weight:600;font-size:1.08rem;'>불러오는 중...</div>
            </div>
        </div>`;
        try {
            const res = await fetch(url, {
                method: 'GET',
                headers: {
                    ...getAuthHeaders()
                }
            });
            if (!res.ok) {
                postListEl.innerHTML = `<div style='text-align:center;padding:32px 0;color:#888;font-size:1.15rem;'>게시글을 불러오지 못했습니다.</div>`;
                return;
            }
            const posts = await res.json();
            renderPosts(posts);
        } catch(e) {
            postListEl.innerHTML = `<div style='text-align:center;padding:32px 0;color:#888;font-size:1.15rem;'>네트워크 오류</div>`;
        }
    }

    function renderPosts(posts) {
        if (!posts || posts.length === 0) {
            postListEl.innerHTML = `<div style='text-align:center;padding:40px 0;color:#b6b8d6;font-size:1.18rem;font-weight:600;'>게시글이 없습니다.</div>`;
            return;
        }
        postListEl.innerHTML = '';
        posts.forEach(p => {
            const div = document.createElement('div');
            div.className = 'post fade-in';
            div.style.cursor = 'pointer';
            div.innerHTML = `
      <div style="display:flex;align-items:flex-start;gap:18px;">
        <div class="avatar" style="width:48px;height:48px;border-radius:50%;background:#e6f9ee;display:flex;align-items:center;justify-content:center;font-size:1.5rem;font-weight:700;color:#03c75a;box-shadow:0 2px 8px rgba(3,199,90,0.08);">
          ${p.authorName ? p.authorName[0].toUpperCase() : 'A'}
        </div>
        <div style="flex:1;">
          <div style="display:flex;align-items:center;gap:10px;">
            <span style="font-weight:600;color:#03c75a;">${escapeHtml(p.authorName || p.author || '알 수 없음')}</span>
            <span style="color:#b6b8d6;font-size:.98em;">${p.createdAt ? p.createdAt : ''}</span>
          </div>
          <div class="title" style="font-size:1.18rem;font-weight:700;margin:6px 0 8px 0;color:#222;">${escapeHtml(p.title || '(제목 없음)')}</div>
          <div class="excerpt" style="margin-bottom:10px;color:#222;">${escapeHtml((p.content || '')).substring(0,120)}${(p.content && p.content.length>120)?'...':''}</div>
          <div style="display:flex;align-items:center;gap:16px;">
            <button class="btn primary small btn-like" title="좋아요">좋아요 <span style="margin-left:4px;">${p.likeCount ?? p.likes ?? 0}</span></button>
            <button class="btn secondary small btn-unlike" title="좋아요 취소">취소</button>
            <button class="btn danger small btn-delete" title="삭제">삭제</button>
          </div>
        </div>
      </div>
    `;
            // 카드 전체 클릭 시 상세 페이지 이동
            div.addEventListener('click', (e) => {
                // 버튼 클릭 시에는 상세 이동 막기
                if (e.target.closest('button')) return;
                window.location.href = `viewpost.html?id=${p.id}`;
            });
            const likeBtn = div.querySelector('.btn-like');
            const unlikeBtn = div.querySelector('.btn-unlike');
            const deleteBtn = div.querySelector('.btn-delete');
            const likeCountEl = likeBtn.querySelector('span');

            likeBtn.addEventListener('click', (e) => { e.stopPropagation(); sendLike(p.id, true, likeCountEl); });
            unlikeBtn.addEventListener('click', (e) => { e.stopPropagation(); sendLike(p.id, false, likeCountEl); });
            deleteBtn.addEventListener('click', (e) => { e.stopPropagation(); deletePost(p.id); });

            postListEl.appendChild(div);
        });
    }

    async function sendLike(postId, isLike, likeCountEl) {
        const token = getToken();
        if (!token) return alert('로그인이 필요합니다.');
        const url = BASE_URL + `/api/posts/${postId}/${isLike ? 'like' : 'unlike'}`;
        try {
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (res.ok) {
                loadPosts();
            } else {
                const t = await res.text();
                alert(t || '요청 실패');
            }
        } catch(e) {
            alert('네트워크 오류');
        }
    }

    async function deletePost(postId) {
        const token = getToken();
        if (!token) return alert('로그인이 필요합니다.');
        if (!confirm('정말 삭제하시겠습니까?')) return;
        try {
            const res = await fetch(BASE_URL + `/api/posts/${postId}`, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (res.ok) {
                alert('삭제 완료');
                loadPosts();
            } else {
                const t = await res.text();
                alert(t || '삭제 실패');
            }
        } catch(e) {
            alert('네트워크 오류');
        }
    }

    async function loadCategoriesForBar() {
        try {
            const res = await fetch(BASE_URL + '/api/categories', { method: 'GET', headers: { ...getAuthHeaders() } });
            if (!res.ok) return;
            const categories = await res.json();
            renderCategoryBtnBar(categories);
        } catch(e) {}
    }
    function renderCategoryBtnBar(categories) {
        const bar = document.getElementById('categoryBtnBar');
        bar.innerHTML = '';
        // 전체 보기 버튼
        const allBtn = document.createElement('button');
        allBtn.className = 'btn ghost small';
        allBtn.textContent = '전체';
        allBtn.onclick = () => loadPosts();
        bar.appendChild(allBtn);
        // 카테고리별 버튼
        categories.forEach(cat => {
            const btn = document.createElement('button');
            btn.className = 'btn secondary small';
            btn.textContent = cat.name || cat.title || `카테고리 ${cat.id}`;
            btn.onclick = () => loadPosts(BASE_URL + `/api/categories/${cat.id}/posts`);
            bar.appendChild(btn);
        });
    }

    btnRefresh.addEventListener('click', () => loadPosts());
    btnCreateToggle.addEventListener('click', () => {
        window.location.href = 'createpost.html';
    });
    btnMypage.addEventListener('click', () => {
        window.location.href = 'mypage.html';
    });
    btnLogout.addEventListener('click', () => {
        localStorage.removeItem('jwt_token');
        alert('로그아웃 되었습니다.');
        window.location.href = 'login.html';
    });

    createForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const token = getToken();
        if (!token) return alert('로그인이 필요합니다.');

        const body = {
            title: document.getElementById('title').value.trim(),
            content: document.getElementById('content').value.trim(),
            tags: (document.getElementById('tags').value || '').split(',').map(s=>s.trim()).filter(Boolean),
            categoryId: document.getElementById('categoryId').value ? Number(document.getElementById('categoryId').value) : null
        };

        try {
            const res = await fetch(BASE_URL + '/api/posts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify(body)
            });
            if (res.ok) {
                document.getElementById('createMsg').textContent = '작성 완료';
                document.getElementById('createErr').textContent = '';
                createForm.reset();
                loadPosts();
            } else {
                const t = await res.text();
                document.getElementById('createErr').textContent = t || '작성 실패';
            }
        } catch(e) {
            document.getElementById('createErr').textContent = '네트워크 오류';
        }
    });

    document.getElementById('btnSearchTitle').addEventListener('click', () => {
        const kw = document.getElementById('searchTitle').value.trim();
        if (!kw) return loadPosts();
        loadPosts(BASE_URL + `/api/posts/search/title?keyword=${encodeURIComponent(kw)}`);
    });
    document.getElementById('btnSearchContent').addEventListener('click', () => {
        const kw = document.getElementById('searchContent').value.trim();
        if (!kw) return loadPosts();
        loadPosts(BASE_URL + `/api/posts/search/content?keyword=${encodeURIComponent(kw)}`);
    });
    document.getElementById('btnSearchTag').addEventListener('click', () => {
        const kw = document.getElementById('searchTag').value.trim();
        if (!kw) return loadPosts();
        loadPosts(BASE_URL + `/api/posts/search/tag?tag=${encodeURIComponent(kw)}`);
    });

    function escapeHtml(str) {
        if (!str) return '';
        return String(str)
            .replaceAll('&','&amp;')
            .replaceAll('<','&lt;')
            .replaceAll('>','&gt;')
            .replaceAll('"','&quot;')
            .replaceAll("'",'&#39;');
    }

    // 페이지 로드 시 게시글 및 카테고리 버튼 로드
    loadPosts();
    loadCategoriesForBar();
</script>
</div>
</body>
</html>